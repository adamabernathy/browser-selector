name: Package macOS App

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  package:
    runs-on: macos-14
    env:
      BUILD_VERSION: ${{ github.run_number }}
      APP_NAME: Browser Switch
      PRODUCT_NAME: BrowserSwitchMenuBarApp
      APP_DIR: dist/Browser Switch.app
      ZIP_PATH: dist/BrowserSwitch-macOS.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show toolchain
        run: |
          xcodebuild -version
          swift --version

      - name: Run tests (no warnings/errors)
        shell: bash
        run: |
          set -euo pipefail
          swift test 2>&1 | tee /tmp/swift-test.log
          if grep -Eqi '(^|[[:space:]])warning:|(^|[[:space:]])error:' /tmp/swift-test.log; then
            echo "Tests produced warnings or errors."
            exit 1
          fi

      - name: Build release binary (no warnings/errors)
        shell: bash
        run: |
          set -euo pipefail
          swift build -c release 2>&1 | tee /tmp/swift-build.log
          if grep -Eqi '(^|[[:space:]])warning:|(^|[[:space:]])error:' /tmp/swift-build.log; then
            echo "Release build produced warnings or errors."
            exit 1
          fi

      - name: Validate signing secrets
        shell: bash
        env:
          DEVELOPER_ID_APP_CERT_BASE64: ${{ secrets.DEVELOPER_ID_APP_CERT_BASE64 }}
          DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_APP_CERT_PASSWORD }}
          DEVELOPER_ID_APP_IDENTITY: ${{ secrets.DEVELOPER_ID_APP_IDENTITY }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          missing=0
          for var in \
            DEVELOPER_ID_APP_CERT_BASE64 \
            DEVELOPER_ID_APP_CERT_PASSWORD \
            DEVELOPER_ID_APP_IDENTITY \
            APPLE_API_KEY_ID \
            APPLE_API_ISSUER_ID \
            APPLE_API_PRIVATE_KEY
          do
            if [ -z "${!var:-}" ]; then
              echo "Missing required secret: ${var}"
              missing=1
            fi
          done
          if [ "${missing}" -ne 0 ]; then
            echo "Signing/notarization secrets are required to publish releases."
            exit 1
          fi

      - name: Create .app bundle
        run: |
          EXECUTABLE_PATH="${APP_DIR}/Contents/MacOS/${APP_NAME}"

          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"

          cp ".build/release/${PRODUCT_NAME}" "${EXECUTABLE_PATH}"
          chmod +x "${EXECUTABLE_PATH}"

          cat > "${APP_DIR}/Contents/Info.plist" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleExecutable</key>
            <string>Browser Switch</string>
            <key>CFBundleIdentifier</key>
            <string>com.adamabernathy.browserswitch</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>Browser Switch</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>${BUILD_VERSION}</string>
            <key>LSMinimumSystemVersion</key>
            <string>12.0</string>
            <key>LSUIElement</key>
            <true/>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          PLIST

      - name: Install signing certificate
        shell: bash
        env:
          DEVELOPER_ID_APP_CERT_BASE64: ${{ secrets.DEVELOPER_ID_APP_CERT_BASE64 }}
          DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_APP_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PASSWORD="$(uuidgen)"
          echo "${DEVELOPER_ID_APP_CERT_BASE64}" | base64 --decode > "${RUNNER_TEMP}/developer-id-cert.p12"
          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${RUNNER_TEMP}/build.keychain"
          security set-keychain-settings -lut 21600 "${RUNNER_TEMP}/build.keychain"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${RUNNER_TEMP}/build.keychain"
          security import "${RUNNER_TEMP}/developer-id-cert.p12" \
            -k "${RUNNER_TEMP}/build.keychain" \
            -P "${DEVELOPER_ID_APP_CERT_PASSWORD}" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security list-keychains -d user -s "${RUNNER_TEMP}/build.keychain" login.keychain
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "${KEYCHAIN_PASSWORD}" \
            "${RUNNER_TEMP}/build.keychain"

      - name: Sign app bundle
        shell: bash
        env:
          DEVELOPER_ID_APP_IDENTITY: ${{ secrets.DEVELOPER_ID_APP_IDENTITY }}
        run: |
          set -euo pipefail
          codesign \
            --force \
            --deep \
            --options runtime \
            --timestamp \
            --sign "${DEVELOPER_ID_APP_IDENTITY}" \
            "${APP_DIR}"

      - name: Verify code signature
        run: |
          codesign --verify --deep --strict --verbose=2 "${APP_DIR}"
          spctl --assess --type execute --verbose=4 "${APP_DIR}"

      - name: Archive app bundle for notarization
        run: |
          ditto -c -k --sequesterRsrc --keepParent "${APP_DIR}" "${ZIP_PATH}"

      - name: Notarize archive
        shell: bash
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          KEY_PATH="${RUNNER_TEMP}/AuthKey_${APPLE_API_KEY_ID}.p8"
          printf "%s" "${APPLE_API_PRIVATE_KEY}" > "${KEY_PATH}"
          xcrun notarytool submit "${ZIP_PATH}" \
            --key "${KEY_PATH}" \
            --key-id "${APPLE_API_KEY_ID}" \
            --issuer "${APPLE_API_ISSUER_ID}" \
            --wait

      - name: Staple notarization ticket
        run: |
          xcrun stapler staple "${APP_DIR}"

      - name: Re-archive stapled app bundle
        run: |
          rm -f "${ZIP_PATH}"
          ditto -c -k --sequesterRsrc --keepParent "${APP_DIR}" "${ZIP_PATH}"

      - name: Move current tag to this commit
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f current "${GITHUB_SHA}"
          git push origin refs/tags/current --force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BrowserSwitch-macOS
          path: ${{ env.ZIP_PATH }}
          if-no-files-found: error

      - name: Publish current release asset
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: current
          name: Current
          prerelease: true
          overwrite_files: true
          body: |
            Auto-published from `main`.
            Build version: `${{ env.BUILD_VERSION }}`
            Commit: `${{ github.sha }}`
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: false

      - name: Publish tagged release asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          prerelease: false
          overwrite_files: true
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: true

      - name: Cleanup signing keychain
        if: always()
        run: |
          security delete-keychain "${RUNNER_TEMP}/build.keychain" || true
          rm -f "${RUNNER_TEMP}/developer-id-cert.p12" || true
